@using System.Runtime.CompilerServices
@using System.Text.RegularExpressions
@using System.Linq
@using System.Text.Json
@using Microsoft.Agents.Core.Models
@using Microsoft.JSInterop
@using Markdig
@inject IJSRuntime JS

@* Guard against null Message during render race conditions *@
@if (Message is null)
{
    return;
}

@if (Message.Role == ChatRole.User)
{
    <div class="user-message">
        @Message.Text
    </div>
}
else if (Message.Role == ChatRole.Assistant)
{
    foreach (var content in Message.Contents)
    {
        if (content is TextContent { Text: { Length: > 0 } text })
        {
            <div class="assistant-message @(InProgress ? "is-streaming" : "streaming-complete")">
                <div class="assistant-message-header">
                    <div class="assistant-message-icon">
                        @CopilotIcon
                    </div>
                    <span>Copilot Studio Agent</span>
                </div>
                <div class="assistant-message-text">
                    @((MarkupString)RenderMarkdown(text))
                </div>
            </div>
        }
        else if (content is FunctionCallContent { CallId: "InformativeMessage" } infoMsg &&
                 infoMsg.Arguments?.TryGetValue("message", out var msgObj) is true &&
                 msgObj is string infoText)
        {
            <!-- Informative message - status/search indicator -->
            <div class="assistant-search">
                <div class="assistant-message-header">
                    <div class="assistant-search-icon">
                        @LoadingIcon
                    </div>
                    <div class="assistant-search-content">
                        <span class="assistant-search-phrase">@infoText</span>
                    </div>
                </div>
            </div>
        }
    }
}
@code {

    // Loading/Processing Icon for informative messages
    private static RenderFragment LoadingIcon => __builder =>
    {
        <div class="loading-icon-container">
            <svg class="loading-sparkle" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                <!-- Main sparkle with animation -->
                <path class="sparkle-main" d="M14 3C14 3 15.5 8.5 17.5 10.5C19.5 12.5 25 14 25 14C25 14 19.5 15.5 17.5 17.5C15.5 19.5 14 25 14 25C14 25 12.5 19.5 10.5 17.5C8.5 15.5 3 14 3 14C3 14 8.5 12.5 10.5 10.5C12.5 8.5 14 3 14 3Z"
                      fill="url(#loadingGradient)" />
                <defs>
                    <linearGradient id="loadingGradient" x1="3" y1="3" x2="25" y2="25" gradientUnits="userSpaceOnUse">
                        <stop offset="0%" stop-color="#7B83EB" />
                        <stop offset="50%" stop-color="#5B5FC7" />
                        <stop offset="100%" stop-color="#6264A7" />
                    </linearGradient>
                </defs>
            </svg>
            <div class="loading-dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        </div>
    };

    // Static pipeline - reuse for performance
    private static readonly MarkdownPipeline MarkdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .UseSoftlineBreakAsHardlineBreak()
        .Build();

    private string RenderMarkdown(string markdown)
    {
        if (string.IsNullOrEmpty(markdown))
            return string.Empty;

        // Remove citation tags if present
        var cleanedMarkdown = Regex.Replace(markdown, @"<citation.*?</citation>", "", RegexOptions.Singleline);

        // Convert markdown to HTML using Markdig
        var html = Markdown.ToHtml(cleanedMarkdown, MarkdownPipeline);

        // Basic HTML sanitization (remove script tags, etc.)
        html = Regex.Replace(html, @"<script.*?</script>", "", RegexOptions.Singleline | RegexOptions.IgnoreCase);
        html = Regex.Replace(html, @"on\w+\s*=\s*[""'][^""']*[""']", "", RegexOptions.IgnoreCase);

        // Convert number-only links to superscript footnotes with brackets FIRST
        html = Regex.Replace(
            html,
            @"<a\s+([^>]*?)>(\d+)</a>",
            @"<sup><a $1 class=""footnote"">[$2]</a></sup>",
            RegexOptions.IgnoreCase
        );

        // Make ALL links open in new tab LAST (applies to all links including footnotes)
        html = Regex.Replace(
            html,
            @"<a\s+",
            @"<a target=""_blank"" rel=""noopener noreferrer"" ",
            RegexOptions.IgnoreCase
        );

        return html;
    }

    private static readonly ConditionalWeakTable<ChatMessage, ChatMessageItem> SubscribersLookup = new();
    private static readonly Dictionary<string, DateTime> IframeRefreshTracking = new();
    private static readonly HashSet<string> ProcessedRecordUpdates = new();


    [Parameter, EditorRequired]
    public required ChatMessage Message { get; set; }

    [Parameter]
    public bool InProgress { get; set; }

    // Copilot Icon as a reusable RenderFragment
    private static RenderFragment CopilotIcon => __builder =>
    {
        <svg viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Main sparkle -->
            <path d="M14 3C14 3 15.5 8.5 17.5 10.5C19.5 12.5 25 14 25 14C25 14 19.5 15.5 17.5 17.5C15.5 19.5 14 25 14 25C14 25 12.5 19.5 10.5 17.5C8.5 15.5 3 14 3 14C3 14 8.5 12.5 10.5 10.5C12.5 8.5 14 3 14 3Z"
                  fill="url(#copilotGradient)" />
            <!-- Small sparkle top-right -->
            <path d="M22 2C22 2 22.5 4 23.5 5C24.5 6 26.5 6.5 26.5 6.5C26.5 6.5 24.5 7 23.5 8C22.5 9 22 11 22 11C22 11 21.5 9 20.5 8C19.5 7 17.5 6.5 17.5 6.5C17.5 6.5 19.5 6 20.5 5C21.5 4 22 2 22 2Z"
                  fill="url(#copilotGradient2)" fill-opacity="0.7" />
            <defs>
                <linearGradient id="copilotGradient" x1="3" y1="3" x2="25" y2="25" gradientUnits="userSpaceOnUse">
                    <stop offset="0%" stop-color="#7B83EB" />
                    <stop offset="50%" stop-color="#5B5FC7" />
                    <stop offset="100%" stop-color="#6264A7" />
                </linearGradient>
                <linearGradient id="copilotGradient2" x1="17.5" y1="2" x2="26.5" y2="11" gradientUnits="userSpaceOnUse">
                    <stop offset="0%" stop-color="#9BA0F0" />
                    <stop offset="100%" stop-color="#7B83EB" />
                </linearGradient>
            </defs>
        </svg>
    };


    protected override void OnInitialized()
    {
        if (Message is not null)
        {
            SubscribersLookup.AddOrUpdate(Message, this);
        }
    }

    public static void NotifyChanged(ChatMessage? source)
    {
        if (source is not null && SubscribersLookup.TryGetValue(source, out var subscriber))
        {
            subscriber.StateHasChanged();
        }
    }

}
